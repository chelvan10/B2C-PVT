# Makefile Documentation: AGENT_EXECUTION_RULES
# Everest-Standard, AI-Agent Guardrail Framework
#
# Purpose: Ensure every line of code generated by an AI agent is consistent,
# reliable, fast, secure, and production-grade — across devices and environments.
#
# -----------------------------------------------------------------------------
# 1. Repository Awareness & Non-Destructive Behavior
# - Detect project context automatically (package.json, config, env, CI).
# - Follow existing conventions (TS/JS, naming, reporters).
# - Enhance, never duplicate. Reuse utilities and POM.
# - Idempotent & safe changes; merge configs, log with AUTOGENERATED tags.
#
# Example:
#   // AUTOGENERATED: [reason] - [timestamp]
#
# -----------------------------------------------------------------------------
# 2. Locator Strategy & Live DOM Exploration
# - Mandate Playwright Inspector/Codegen for locators.
# - Locator hierarchy (strict order):
#     1. getByTestId() (preferred, add if missing)
#     2. getByRole()
#     3. getByText()
#     4. getByLabel / getByPlaceholder / getByAltText
#     5. CSS/XPath last resort, centralized
# - Avoid brittle selectors (nth-child).
# - Recommend adding stable data-testid hooks.
#
# -----------------------------------------------------------------------------
# 3. Architecture & Code Organization
# - Enforce POM (Page Objects: locators + methods; Tests: assertions/flows).
# - Directory structure:
#     /src/page-objects
#     /src/tests
#     /src/fixtures
#     /src/utils
#     /src/data
#     /src/reports
# - Custom fixtures only when needed (geo, auth, media).
# - Tagging strategy (@smoke, @regression, @a11y, @links).
#
# -----------------------------------------------------------------------------
# 4. Quality Gates & Reliability (Zero Flakiness)
# - Respect lint/format rules.
# - Use auto-waiting; never waitForTimeout.
# - Use test.step() for clarity.
# - Parallel-first design; mark stateful serial.
# - Retries only in CI (retries: process.env.CI ? 2 : 0).
#
# -----------------------------------------------------------------------------
# 5. Configuration & Test Data
# - Centralize config in playwright.config.ts.
# - Externalize test data in /src/data/*.json.
# - Support .env overrides (BASE_URL, DEVICE).
# - Seeded randomness for reproducibility (SEED env).
#
# -----------------------------------------------------------------------------
# 6. Network, Permissions & Resilience
# - Control permissions (geo, clipboard).
# - Simulate network conditions (block, throttle).
# - Stub externals intelligently (mock YouTube).
# - Handle new tabs with waitForEvent('popup').
# - Verify media loads (naturalWidth > 0).
#
# -----------------------------------------------------------------------------
# 7. Accessibility & UX Checks
# - Lightweight a11y smoke tests (nav, main, skip links).
# - Ensure focusability and labels.
# - Full axe scans only in dedicated @a11y tests.
#
# -----------------------------------------------------------------------------
# 8. Reporting & CI/CD
# - Respect existing reporters; else enable HTML + Allure.
# - Capture screenshot, video, trace on failure.
# - CI shardable; tag heavy tests (@slow).
# - Store artifacts in /reports, /test-results.
#
# -----------------------------------------------------------------------------
# 9. Documentation & Discoverability
# - Maintain README.md with run commands, tags, SEED usage.
# - Use JSDoc/TSDoc in reusable code.
# - Write intent-rich test titles with structured format.
#   Example: [FEATURE:StoreLocator] [CONDITION:Postcode-Search] @store-switcher Given postcode 0600, should display Auckland stores
#
# -----------------------------------------------------------------------------
# 10. Security & Compliance
# - Never commit secrets (use .env).
# - Mask PII in logs/screenshots.
#   Example: await page.screenshot({ mask: [page.locator('#password')] });
# - Respect org security (SAST scans, dep audits).
#
# -----------------------------------------------------------------------------
# 11. Change Policy & Governance
# - Follow team guardrails or Everest defaults.
# - Provide change summary after generation.
#   Example:
#     📄 Added: src/page-objects/Homepage.ts
#     🔧 Modified: playwright.config.ts
#     📌 Notes: Added @smoke tags, recommended data-testid hooks
#
# -----------------------------------------------------------------------------
# 12. Output Requirements (Non-Negotiable)
# - Must run with `npx playwright test`.
# - Zero lint/type errors (`npm run lint && npx tsc --noEmit`).
# - Stub unimplementable features with TODO contracts.
#
# -----------------------------------------------------------------------------
# 13. Mobile-Optimized Execution
# - Include real + emulated devices (iPhone 15 Pro, Pixel 7).
# - Use tap() APIs, avoid hover-only.
# - Test both portrait & landscape.
# - Support BrowserStack/LambdaTest.
# - Enforce perf budgets (≤60s/spec).
#
# -----------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# 14. Enhanced Test Structure & Coverage Instrumentation (NEW)
# - MANDATORY: Use structured test titles: '[FEATURE:X] [CONDITION:Y] Test Description'
# - Add TestInstrumentation class for coverage data attachment
# - Include rich annotations for dashboard insights:
#     testInfo.annotations.push(
#       { type: 'feature', description: 'FeatureName' },
#       { type: 'condition', description: 'TestCondition' },
#       { type: 'business-impact', description: 'Impact description' },
#       { type: 'coverage-area', description: 'What is being tested' }
#     );
# - Attach coverage data at test end:
#     TestInstrumentation.attachCoverageData(testInfo, {
#       feature: 'FeatureName',
#       condition: 'TestCondition',
#       [metrics]: values,
#       businessImpact: 'critical|high|medium|low'
#     });
#
# Example Enhanced Test Structure:
#   test('[FEATURE:Search] [CONDITION:Homepage-PLP] Search functionality validation', async ({ page }, testInfo) => {
#     testInfo.annotations.push(
#       { type: 'feature', description: 'Search' },
#       { type: 'condition', description: 'Homepage-PLP' },
#       { type: 'business-impact', description: 'Core product discovery functionality' },
#       { type: 'coverage-area', description: 'Search input, results validation, PLP navigation' }
#     );
#     
#     // Test implementation...
#     
#     TestInstrumentation.attachCoverageData(testInfo, {
#       feature: 'Search',
#       condition: 'Homepage-PLP',
#       searchTerm: 'drill',
#       resultsFound: true,
#       businessImpact: 'critical'
#     });
#   });
#
# -----------------------------------------------------------------------------
# 🏁 Final Reminder: The Everest Standard
# - Correctness > Completeness > Speed
# - Stability > Cleverness
# - Cross-Device Consistency > Desktop-Only Perfection
# - Structured Coverage > Ad-hoc Testing
#
# This doc is a covenant for AI agents to internalize before generating code.
# Always ask: "Does this change make the system more resilient, faster, clearer,
# safer, and provide rich coverage insights — without duplication or overkill?"
# If yes, proceed. If no, refine.